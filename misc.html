<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        function captureConsole() {
            if (console.everything === undefined) {
                console.everything = [];
                let TS = _ => new Date().toLocaleString("sv", { timeZone: 'UTC' }) + "Z"; // timestamp function
                window.onerror = function (error, url, line) { // catches all console errors, includes those not made by console.error
                    console.everything.push({ type: "exception", timeStamp: TS(), value: { error, url, line } });
                    return false;
                }
                window.onunhandledrejection = function (e) { // catch some other things, idk
                    console.everything.push({ type: "promiseRejection", timeStamp: TS(), value: e.reason });
                }
                function hookLogType(logType) {
                    const original = console[logType].bind(console); // save orginal function
                    return function (...args) {
                        console.everything.push({ type: logType, timeStamp: TS(), value: Array.from(args) }); // add object to console.everything
                        original.apply(console, args); // log message to console
                    }
                }
                ['log', 'error', 'warn', 'debug'].forEach(logType => { // hook  each log type
                    console[logType] = hookLogType(logType)
                });
                let states = new Map();
                console.saveState = function saveState(id = 0) {
                    let everything = [...console.everything];
                    states.set(id, everything);
                }
                console.restore = function restore(id = 0) {
                    let everything = states.get(id);
                    console.everything = [...everything];
                    console.clear();
                    let max = Math.max(...console.everything.map(e => e.trace.length))
                    console.everything.forEach(function (log) {
                        if (original = console["original" + log.type]) {
                            original.apply(console, [...log.args/* , log.trace.padStart(max + 10, " ") + ", ", log.timeStamp */]);
                        } else {
                            console.originalerror.apply(console, [...log.args]);
                        }
                    });
                }
            }
        }
        // captureConsole();
    </script>
    <meta charset="UTF-8">
    <!-- auto refresh page every 5 seconds -->
    <!-- <meta http-equiv="refresh" content="5"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        div#box {
            width: 200px;
            height: 20px;
            border: 1px solid black;
        }

        div#bar {
            height: 100%;
            background: red;
            display: inline-block;
        }

        body>div {
            width: 100%;
            height: 100%;
        }

        body>div>pre {
            display: inline-block;
            width: 50%;
            height: 100%;
            border: 1px solid black;
            box-sizing: border-box;
            padding: 10px;
        }

        span.add {
            background-color: green;
            color: white;
        }

        span.delete {
            background-color: red;
        }

        #autosave {
            border: 1px solid black;
            width: 100px;
            height: 10px;
        }

        #autosave .bar {
            background-color: red;
            height: 100%;
        }

        div.hovering {
            position: relative;
            height: 180px;
        }

        div.hovering>div.hover,
        div.hovering>div.keep-hover {
            border-color: red;
        }

        div.hovering>div:nth-child(1) {
            left: 10px;
            top: 10px;
        }

        div.hovering>div:nth-child(2) {
            left: 20px;
            top: 20px;
        }

        div.hovering>div:nth-child(3) {
            left: 30px;
            top: 30px;
        }

        div.hovering>div:nth-child(4) {
            left: 40px;
            top: 40px;
        }

        div.hovering>div:nth-child(5) {
            left: 50px;
            top: 50px;
        }

        div.hovering>div:nth-child(6) {
            left: 60px;
            top: 60px;
        }

        div.hovering>div {
            width: 100px;
            height: 100px;
            border: 2px solid green;
            position: absolute;
            background-color: #0002;
            content: attr(data-value)
        }

        div.calendar {
            --day-size: 60px;
            border: 1px solid black;
            display: inline-block;
        }

        div.calendar div.day {
            height: var(--day-size);
            width: var(--day-size);
            display: inline-block;
            border: 1px solid black;
            box-sizing: border-box;
        }

        div.settings {
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            color: white;
            flex-wrap: wrap;
            height: 100%;
        }

        div.settings h2 {
            padding: 0px 10px;
        }

        div.settings>section {
            border: 1px solid black;
            border-radius: 9px;
            padding-top: 10px;
            background-color: #454d55;
            width: 300px;
        }

        div.settings>section {
            display: none;
        }

        div.settings>section:has(label) {
            display: unset;
        }

        div.settings>section>label {
            border-top: 1px solid black;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            user-select: none;
        }
    </style>
</head>

<body>
    <details>
        <summary>autosave</summary>
        <div id="autosave">
            <div class="bar"></div>
        </div>
        <div id="autosavestatus"></div>
        <textarea name="" id="autosaveeditor" cols="30" rows="10"></textarea>
        <script>
            r = _ => console.log(document.querySelector("#autosavestatus").innerHTML = "Saved!");
            let counter = 100;
            let seconds = 1;
            document.querySelector("#autosaveeditor").oninput = (_ => counter = 100);
            setInterval(_ => counter ? (counter--, document.querySelector("#autosavestatus").innerHTML = "Waiting...", document.querySelector("#autosave .bar").style.width = counter + "%", !counter ? r() : 0) : 0, seconds * 10);
        </script>
    </details>
    <details>
        <summary>passthrough hovering/clicking</summary>
        <div class="hovering">
            <div data-value="1"></div>
            <div data-value="2"></div>
            <div data-value="3"></div>
            <div data-value="4"></div>
            <div data-value="5"></div>
            <div data-value="6"></div>
        </div>
        <div id="value-display"></div>
        <script>
            function readHoveredDivs() {
                let els = Array.from(document.querySelectorAll(".hovering>div.keep-hover,.hovering>div.hover")); // get all elements that are kept or hovered
                let values = els.map(e => e.dataset.value); // get each element's value
                document.getElementById("value-display").innerHTML = values.join(","); // join array of values with comma and set innerhtml
            }
            function captureMouse(keep, cls) { // wrapper function for ease of use
                return function (event) {
                    document.querySelectorAll("div.hovering>div." + cls).forEach(e => e.classList.remove(cls)); // clear class from all elements that have it
                    if (keep && document.querySelector("div.hovering>div.keep-hover")) return; // return if keep-hover detected
                    let { clientX, clientY } = event; // get x/y coordinates of event
                    document.elementsFromPoint(clientX, clientY).forEach(e => { // get all elements that overlap the coordinates
                        if (e.matches("div.hovering>div")) { // if element is a valid target element
                            e.classList.add(cls); // add the class
                        }
                    });
                    readHoveredDivs(); // update info display
                }
            }
            window.onmousemove = captureMouse(true, "hover"); // highlight divs on hover
            window.onclick = captureMouse(false, "keep-hover"); // toggle highlight divs on click
        </script>
    </details>
    <div id="root"></div>
    <button id="notification-button" type="button">send notification</button>
    <button id="notification-cancel" type="button">cancel notification</button>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./js/service-worker.js');
        }
        document.querySelector('#notification-button').onclick = async () => {
            const reg = await navigator.serviceWorker.getRegistration();
            // console.log(navigator.serviceWorker.getRegistration);
            Notification.requestPermission().then((permission) => {
                // console.log(permission);
                if (permission !== 'granted') {
                    alert('you need to allow push notifications');
                } else {
                    navigator.serviceWorker.getRegistration().then(async (reg) => {
                        if (reg === undefined) {
                            reg = await navigator.serviceWorker.register('./js/service-worker.js');
                        }
                        const timestamp = new Date().getTime() + 5000; // now plus 5000ms
                        reg.showNotification(
                            'Demo Push Notification',
                            {
                                tag: timestamp, // a unique ID
                                body: 'Hello World', // content of the push notification
                                timestamp: timestamp, // set the time for the push notification
                                data: {
                                    url: window.location.href, // pass the current url to the notification
                                },
                                badge: '/favicon.ico',
                                icon: '/favicon.ico',
                                actions: [
                                    { action: 'markasread', title: 'Mark as Read' },
                                    { action: 'close', title: 'Dismiss', }
                                ],
                            }
                        );
                    });
                }
            });
        };
        document.querySelector('#notification-cancel').onclick = async () => {
            const reg = (await navigator.serviceWorker.getRegistrations())[0];
            const notifications = await reg.getNotifications({
                includeTriggered: true
            });
            notifications.forEach(notification => notification.close());
            alert(`${notifications.length} notification(s) cancelled`);
        };
        navigator.serviceWorker.addEventListener('message', event => console.log(event.data));
    </script>
    <input-slider checked="true"></input-slider>
    <script type="module">
        import { settings, CUSTOM_ELEMENTS } from "./js/jstools.js";
        CUSTOM_ELEMENTS.all();
        console.log(settings);
        import { loadFormatters } from "/js/custom formatters/loader.js";
        loadFormatters();

        console.log({
            "schedules": [{
                "start": "2024-05-01T17:00:00-05:00",
                "end": "2024-05-01T18:00:00-05:00",
                "date": "2024-05-01T00:00:00-05:00"
            }, {
                "start": "2024-05-02T09:00:00-05:00",
                "end": "2024-05-02T17:00:00-05:00",
                "date": "2024-05-02T00:00:00-05:00"
            }]
        });
    </script>
    <script type="module">
        import { Grid } from "./js/console_game.js";
        // let game = new Grid(7, 10)
    </script>
    <script> // convert html element to xml string without properties
        function thisThing(element) {
            const formatter = [];

            function traverse(element, indent) {
                const { tagName, childNodes } = element;
                const formattedElement = `${indent}<${tagName}>`;
                formatter.push(formattedElement);

                for (let i = 0; i < childNodes.length; i++) {
                    const child = childNodes[i];

                    if (child.nodeType === Node.ELEMENT_NODE) {
                        traverse(child, indent + " ".repeat(4)); // 4 spaces for indentation
                    } else if (child.nodeType === Node.TEXT_NODE) {
                        const formattedText = `${indent}  ${child.textContent}`;
                        formatter.push(formattedText);
                    }
                }

                const closingTag = `${indent}</${tagName}>`;
                formatter.push(closingTag);
            }

            traverse(element, '');

            return formatter.join('\n');
        }
        thisThing(document.body);
    </script>
    <!--☺☻♥♦♣♠•◘○◙♂♀♪♫☼►◄↕‼¶§▬↨↑↓→←∟↔▲▼ 
        !"#$%&'()*+,-./0123456789:;<=>?@
        ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`
        abcdefghijklmnopqrstuvwxyz{|}~⌂Ç
        üéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜ¢£¥₧ƒá
        íóúñÑªº¿⌐¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└
        ┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀α
        ßΓπΣσµτΦΘΩδ∞φε∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■&nbsp;-->
    <!-- list of all named HTML entities
´:&acute;
α:&alpha;
Α:&Alpha;
&:&amp;
∧:&and;
∠:&ang;
≈:&asymp;
„:&bdquo;
β:&beta;
Β:&Beta;
¦:&brvbar;
•:&bull;
∩:&cap;
¸:&cedil;
¢:&cent;
χ:&chi;
Χ:&Chi;
ˆ:&circ;
♣:&clubs;
≅:&cong;
©:&copy;
↵:&crarr;
∪:&cup;
¤:&curren;
†:&dagger;
‡:&Dagger;
↓:&darr;
°:&deg;
δ:&delta;
Δ:&Delta;
♦:&diams;
÷:&divide;
∅:&empty;
ε:&epsilon;
Ε:&Epsilon;
≡:&equiv;
η:&eta;
Η:&Eta;
€:&euro;
∃:&exist;
ƒ:&fnof;
∀:&forall;
½:&frac12;
¼:&frac14;
¾:&frac34;
γ:&gamma;
Γ:&Gamma;
≥:&ge;
>:&gt;
↔:&harr;
♥:&hearts;
…:&hellip;
¡:&iexcl;
∞:&infin;
∫:&int;
ι:&iota;
Ι:&Iota;
¿:&iquest;
∈:&isin;
κ:&kappa;
Κ:&Kappa;
λ:&lambda;
Λ:&Lambda;
«:&laquo;
←:&larr;
⌈:&lceil;
“:&ldquo;
≤:&le;
⌊:&lfloor;
∗:&lowast;
◊:&loz;
‎:&lrm;
‹:&lsaquo;
‘:&lsquo;
<:&lt;
¯:&macr;
—:&mdash;
µ:&micro;
−:&minus;
μ:&mu;
Μ:&Mu;
∇:&nabla;
–:&ndash;
≠:&ne;
∋:&ni;
¬:&not;
∉:&notin;
⊄:&nsub;
ν:&nu;
Ν:&Nu;
œ:&oelig;
Œ:&OElig;
‾:&oline;
ω:&omega;
Ω:&Omega;
ο:&omicron;
Ο:&Omicron;
⊕:&oplus;
∨:&or;
ª:&ordf;
º:&ordm;
⊗:&otimes;
¶:&para;
∂:&part;
‰:&permil;
⊥:&perp;
φ:&phi;
Φ:&Phi;
π:&pi;
Π:&Pi;
ϖ:&piv;
±:&plusmn;
£:&pound;
′:&prime;
″:&Prime;
∏:&prod;
∝:&prop;
ψ:&psi;
Ψ:&Psi;
√:&radic;
»:&raquo;
→:&rarr;
⌉:&rceil;
”:&rdquo;
®:&reg;
⌋:&rfloor;
ρ:&rho;
Ρ:&Rho;
‏:&rlm;
›:&rsaquo;
’:&rsquo;
‚:&sbquo;
š:&scaron;
Š:&Scaron;
⋅:&sdot;
§:&sect;
σ:&sigma;
Σ:&Sigma;
ς:&sigmaf;
∼:&sim;
♠:&spades;
⊂:&sub;
⊆:&sube;
∑:&sum;
⊃:&sup;
¹:&sup1;
²:&sup2;
³:&sup3;
⊇:&supe;
τ:&tau;
Τ:&Tau;
∴:&there4;
θ:&theta;
Θ:&Theta;
ϑ:&thetasym;
˜:&tilde;
×:&times;
™:&trade;
↑:&uarr;
¨:&uml;
ϒ:&upsih;
υ:&upsilon;
Υ:&Upsilon;
ξ:&xi;
Ξ:&Xi;
¥:&yen;
Ÿ:&Yuml;
ζ:&zeta;
Ζ:&Zeta;
-->
    <script src="./js/goto.js"></script>
    <script type="text/jsplusgoto">
        var log = [],
            p = 0;

        var testGoTo = function testGoto() {

            // Goto calls inside of nested functions work
            this.logme = function tgLogMe(num, times) {
                var j = 0;
                [lbl] logtop:
                if (j < times) {
                    log.push(num);
                    j++;
                    goto logtop;
                }
                console.log("goto log", log.join('|'));
            };

            // Safe strings
            var proof = "Strings with special chars like -- ";
            proof = "function() { -- & -- goto lbl -- & -- [lbl] test";
            proof = "-- are totally safe!";

            // Nested/Overlapping Gotos (aka the magic)
            var i = 0,
                j = 0;
            [lbl] top:
            i++;
            [lbl] middle:
            j++;
            if (i < 10) {
                goto top;
            }
            if (j < 22) {
                goto middle;
            }

            // p was set below at 11
            // j-i should be 22-10 = 12
            this.logme(p, j - i);

            return j - i;
        };

        // Functions don't need to exist to use goto
        // In fact... functions are for the weak.
        [lbl] outsideLabel:
        p++;
        if (p < 11) {
            goto outsideLabel;
        }
    </script>
    <script>
        // Ideally this would actually be the onDomReady function of your choice...
        var otherload = window.onload;
        window.onload = function () {
            if (typeof otherload != "undefined") { otherload(); }
            console.log("test goto", testGoTo());
        };
    </script>
</body>

</html>